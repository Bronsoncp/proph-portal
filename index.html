<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Proph Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{margin:0;background:#0b0b0b;color:#fff;font-family:Inter,system-ui,sans-serif}
    .tabs{display:flex;gap:10px;background:#111;padding:10px}
    .tabs button{padding:8px 12px;background:#222;border:none;color:#fff;cursor:pointer;border-radius:6px}
    .tabs button.active{background:#ffd54a;color:#000;font-weight:700}
    .page{display:none;padding:20px}
    .page.active{display:block}
    .card{background:#1a1a1a;border-radius:10px;padding:16px;margin:10px 0}
    input,textarea,select{width:100%;padding:8px;border-radius:6px;border:1px solid #333;background:#000;color:#fff;margin:6px 0}
    .btn{padding:8px 12px;border-radius:6px;background:#ffd54a;color:#000;font-weight:600;border:none;cursor:pointer}
    video{width:100%;margin-top:10px;border-radius:8px}
    pre{background:#000;padding:10px;border-radius:6px;white-space:pre-wrap}
  </style>
</head>
<body>
  <nav class="tabs">
    <button data-tab="home" class="active">Home</button>
    <button data-tab="create">Create</button>
  </nav>

  <section class="page active" data-page="home">
    <h1>Welcome to Proph Portal</h1>
    <p>Use the tabs above to navigate. Test Create features below.</p>
  </section>

  <section class="page" data-page="create">
    <h1>Create Tools</h1>

    <div class="card">
      <h3>üé¨ Clip Wizard</h3>
      <input type="file" id="cwFile" accept="audio/*,video/*">
      <input id="cwStart" placeholder="Start mm:ss" value="0:00">
      <input id="cwDur" placeholder="Duration (s)" value="12">
      <select id="cwRes"><option>1080x1920</option><option>720x1280</option></select>
      <select id="cwCrop"><option value="center">Center</option><option value="top">Top</option><option value="bottom">Bottom</option></select>
      <button class="btn" id="cwMake">Generate</button>
      <div id="cwStatus"></div>
      <video id="cwPreview" controls></video>
      <a id="cwDownload" class="btn" style="display:none" download="proph_clip.mp4">Download MP4</a>
    </div>

    <div class="card">
      <h3>üéØ Hook Finder</h3>
      <input type="file" id="hookFile" accept="audio/*">
      <button class="btn" id="hookAnalyze">Analyze</button>
      <ol id="hookOut"></ol>
    </div>

    <div class="card">
      <h3>‚úçÔ∏è Fan Story Generator</h3>
      <textarea id="storyInput" rows="3" placeholder="Describe vibe/lyric"></textarea>
      <button class="btn" id="storyGen">Generate copy</button>
      <pre id="storyOut"></pre>
    </div>
  </section>

  <!-- ffmpeg libraries BEFORE our script -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
  <script src="https://unpkg.com/@ffmpeg/util@0.12.6/dist/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.6/dist/index.min.js"></script>

  <script>
    // Tab navigation
    document.querySelectorAll('.tabs button').forEach(btn=>{
      btn.onclick=()=>{
        document.querySelector('.tabs button.active')?.classList.remove('active');
        btn.classList.add('active');
        const tab=btn.getAttribute('data-tab');
        document.querySelectorAll('.page').forEach(p=>p.classList.toggle('active',p.dataset.page===tab));
      };
    });

    // Wait for FFmpeg
    function whenFFmpegReady(fn){
      if(window.FFmpeg&&FFmpeg.createFFmpeg) return fn();
      const t=setInterval(()=>{if(window.FFmpeg&&FFmpeg.createFFmpeg){clearInterval(t);fn();}},300);
    }

    // Clip Wizard
    whenFFmpegReady(()=>{
      const { createFFmpeg, fetchFile } = FFmpeg;
      const ff = createFFmpeg({ log:false });
      async function ensureFF(){ if(!ff.isLoaded()){ document.getElementById('cwStatus').textContent='Loading ffmpeg‚Ä¶'; await ff.load(); document.getElementById('cwStatus').textContent='ffmpeg ready.'; } }
      function parseTime(t){const p=(t||'0:00').split(':'),m=+p[0]||0,s=+p[1]||0;return m*60+s;}
      document.getElementById('cwMake').onclick=async()=>{
        const f=document.getElementById('cwFile').files[0];
        if(!f){alert('Pick a file first');return;}
        await ensureFF();
        const start=parseTime(document.getElementById('cwStart').value);
        const dur=parseFloat(document.getElementById('cwDur').value||'12');
        const [W,H]=document.getElementById('cwRes').value.split('x').map(Number);
        const crop=document.getElementById('cwCrop').value;
        const isAudio=/\.(mp3|wav|m4a|aac|flac)$/i.test(f.name);
        const inN='in', outN='out.mp4';
        ff.FS('writeFile', inN, await fetchFile(f));
        let args=[];
        if(isAudio){
          args=['-f','lavfi','-i',`color=size=${W}x${H}:rate=30:color=black`,'-i',inN,'-ss',String(start),'-t',String(dur),'-shortest','-c:v','libx264','-pix_fmt','yuv420p','-c:a','aac','-b:a','192k',outN];
        }else{
          const pos = crop==='top'?0:(crop==='bottom'?'(in_h-out_h)':'(in_h-out_h)/2');
          const filter = `scale=-2:${H},crop=${W}:${H}:(in_w-${W})/2:${pos}`;
          args=['-ss',String(start),'-t',String(dur),'-i',inN,'-vf',filter,'-r','30','-c:v','libx264','-pix_fmt','yuv420p','-c:a','aac','-b:a','192k',outN];
        }
        try{
          document.getElementById('cwStatus').textContent='Processing‚Ä¶';
          await ff.run(...args);
          const data=ff.FS('readFile', outN);
          const url=URL.createObjectURL(new Blob([data.buffer],{type:'video/mp4'}));
          document.getElementById('cwPreview').src=url;
          const a=document.getElementById('cwDownload'); a.href=url; a.style.display='inline-block';
          document.getElementById('cwStatus').textContent='Done.';
        }catch(err){
          console.error(err);
          document.getElementById('cwStatus').textContent='Error (open Console)';
        }finally{try{ff.FS('unlink',outN)}catch{} try{ff.FS('unlink',inN)}catch{}}
      };
    });

    // Hook Finder
    document.getElementById('hookAnalyze').onclick=async()=>{
      const f=document.getElementById('hookFile').files[0];
      const out=document.getElementById('hookOut'); out.innerHTML='';
      if(!f){out.innerHTML='<li>Upload an audio file first.</li>';return;}
      const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const audio=await ctx.decodeAudioData(await f.arrayBuffer());
      const step=Math.floor(audio.sampleRate*0.25); const ch=audio.getChannelData(0); const energies=[];
      for(let i=0;i<ch.length;i+=step){let s=0; for(let j=0;j<step&&i+j<ch.length;j++){s+=ch[i+j]*ch[i+j]} energies.push({i,e:s/step});}
      energies.sort((a,b)=>b.e-a.e);
      const picks=energies.slice(0,3).map(x=>x.i/audio.sampleRate).sort((a,b)=>a-b);
      const fmt=t=>`${String(Math.floor(t/60)).padStart(2,'0')}:${String(Math.floor(t%60)).padStart(2,'0')}`;
      picks.forEach(t=>{const li=document.createElement('li'); li.textContent=`${fmt(t)}‚Äì${fmt(t+12)} (hook)`;
        out.appendChild(li);});
    };

    // Fan Story
    document.getElementById('storyGen').onclick=()=>{
      const vibe=(document.getElementById('storyInput').value||'London grind').trim();
      document.getElementById('storyOut').textContent=
        `POV: you stopped waiting for permission.\n‚ÄúHurts The New Sexy‚Äù is for the ones who turn pressure into diamonds.\nVibe: ${vibe}\nIf you feel this, save & tag someone who needs the reminder.`;
    };
  </script>
</body>
</html>

